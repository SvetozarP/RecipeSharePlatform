<div class="reviews-container">
      <!-- Reviews Header -->
      <div class="reviews-header" *ngIf="showHeader">
        <h3 class="reviews-title">
          <mat-icon>rate_review</mat-icon>
          Reviews ({{ totalCount }})
        </h3>
        
        <div class="sorting-controls" *ngIf="reviews.length > 0">
          <mat-form-field appearance="fill" class="sort-field">
            <mat-label>Sort by</mat-label>
            <mat-select [value]="sortBy" (selectionChange)="onSortChange($event.value)">
              <mat-option value="-created_at">Newest First</mat-option>
              <mat-option value="created_at">Oldest First</mat-option>
              <mat-option value="-rating">Highest Rated</mat-option>
              <mat-option value="rating">Lowest Rated</mat-option>
              <mat-option value="-helpful_count">Most Helpful</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p class="loading-text">Loading reviews...</p>
      </div>

      <!-- No Reviews State -->
      <div *ngIf="!loading && reviews.length === 0" class="no-reviews">
        <mat-icon class="no-reviews-icon">rate_review</mat-icon>
        <h4>No reviews yet</h4>
        <p>Be the first to share your thoughts about this recipe!</p>
      </div>

      <!-- Reviews List -->
      <div *ngIf="!loading && reviews.length > 0" class="reviews-list">
        <div 
          *ngFor="let review of reviews; trackBy: trackByReviewId" 
          class="review-item"
          [class.highlighted]="highlightedReviewId === review.id">
          
          <!-- Review Header -->
          <div class="review-header">
            <div class="reviewer-info">
              <div class="reviewer-avatar">
                <mat-icon>account_circle</mat-icon>
              </div>
              <div class="reviewer-details">
                <div class="reviewer-name">
                  {{ review.user_name }}
                  <mat-chip 
                    *ngIf="review.is_verified_purchase" 
                    class="verified-chip"
                    matTooltip="Verified - This user has made this recipe">
                    <mat-icon>verified</mat-icon>
                    Verified
                  </mat-chip>
                </div>
                <div class="review-meta">
                  <app-star-rating 
                    [value]="review.rating" 
                    [interactive]="false"
                    [size]="16">
                  </app-star-rating>
                  <span class="review-date">{{ formatDate(review.created_at) }}</span>
                </div>
              </div>
            </div>

            <!-- Review Actions (for authenticated users) -->
            <div class="review-actions" *ngIf="isAuthenticated">
              <button 
                mat-icon-button
                *ngIf="!currentUserReview || currentUserReview.id !== review.id"
                [disabled]="helpfulClicked().has(review.id)"
                (click)="onMarkHelpful(review)"
                [matTooltip]="helpfulClicked().has(review.id) ? 'Already marked as helpful' : 'Mark as helpful'">
                <mat-icon 
                  [class.text-primary]="helpfulClicked().has(review.id)">
                  thumb_up
                </mat-icon>
              </button>

                             <!-- Edit/Delete buttons for own reviews (not shown to recipe authors) -->
               <div *ngIf="!isRecipeAuthor && currentUserReview && currentUserReview.id === review.id" class="own-review-actions">
                 <button 
                   mat-icon-button
                   (click)="onEditReview(review)"
                   matTooltip="Edit your review">
                   <mat-icon>edit</mat-icon>
                 </button>
                 <button 
                   mat-icon-button
                   color="warn"
                   (click)="onDeleteReview(review)"
                   matTooltip="Delete your review">
                   <mat-icon>delete</mat-icon>
                 </button>
               </div>
            </div>
          </div>

          <!-- Review Content -->
          <div class="review-content" *ngIf="review.review && review.review.trim()">
            <p class="review-text">{{ review.review }}</p>
          </div>

          <!-- Review Footer -->
          <div class="review-footer" *ngIf="review.helpful_count > 0">
            <div class="helpful-count">
              <mat-icon class="helpful-icon">thumb_up</mat-icon>
              <span>{{ review.helpful_count }} people found this helpful</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Load More Button -->
      <div *ngIf="hasMore && !loading" class="load-more-container">
        <button 
          mat-raised-button 
          color="primary"
          (click)="onLoadMore()"
          [disabled]="loadingMore">
          <mat-spinner diameter="20" *ngIf="loadingMore"></mat-spinner>
          <span *ngIf="!loadingMore">Load More Reviews</span>
          <span *ngIf="loadingMore">Loading...</span>
        </button>
      </div>
    </div>