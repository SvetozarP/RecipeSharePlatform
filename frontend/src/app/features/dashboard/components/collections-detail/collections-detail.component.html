<div class="collections-detail">
  <!-- Header Section -->
  <div class="collections-header">
    <div class="title-section">
      <h1 class="page-title">
        <mat-icon>folder</mat-icon>
        Recipe Collections
      </h1>
      <p class="page-subtitle">Organize and manage your recipe collections</p>
    </div>
    
    <div class="header-actions">
      <button 
        mat-raised-button 
        color="primary" 
        (click)="onCreateCollection()">
        <mat-icon>add</mat-icon>
        New Collection
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <app-loading *ngIf="isLoading" [message]="'Loading your collections...'"></app-loading>

  <!-- Collections Content -->
  <div *ngIf="!isLoading" class="collections-content">
    
    <!-- No Collections State -->
    <div *ngIf="!hasCollections" class="no-collections">
      <mat-card class="no-collections-card">
        <mat-icon class="no-collections-icon">folder_open</mat-icon>
        <h3>No collections yet</h3>
        <p>Collections help you organize your favorite recipes. Create your first collection to get started!</p>
        <div class="no-collections-actions">
          <button 
            mat-raised-button 
            color="primary" 
            (click)="onCreateCollection()">
            <mat-icon>add</mat-icon>
            Create Your First Collection
          </button>
        </div>
      </mat-card>
    </div>

    <!-- Collections Layout -->
    <div *ngIf="hasCollections" class="collections-layout">
      
      <!-- Collections Sidebar -->
      <div class="collections-sidebar">
        <mat-card class="sidebar-card">
          <mat-card-header>
            <mat-card-title>Your Collections</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="collections-list">
              <div 
                *ngFor="let collection of collections; trackBy: trackByCollectionId"
                class="collection-item"
                [class.selected]="selectedCollection?.id === collection.id"
                (click)="selectCollection(collection)">
                
                <div class="collection-icon">
                  <mat-icon>{{ collection.is_public ? 'public' : 'folder' }}</mat-icon>
                </div>
                
                <div class="collection-info">
                  <h4 class="collection-name">{{ collection.name }}</h4>
                  <p class="collection-description" *ngIf="collection.description">
                    {{ collection.description }}
                  </p>
                  <div class="collection-meta">
                    <span class="recipe-count">
                      {{ collection.recipe_count }} recipe{{ collection.recipe_count !== 1 ? 's' : '' }}
                    </span>
                    <span class="visibility" *ngIf="collection.is_public">
                      <mat-icon class="visibility-icon">public</mat-icon>
                      Public
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Collection Detail -->
      <div class="collection-detail" *ngIf="selectedCollection">
        
        <!-- Collection Header -->
        <mat-card class="collection-header-card">
          <mat-card-header>
            <div class="collection-title-section">
              <mat-card-title class="collection-title">
                <mat-icon>{{ selectedCollection.is_public ? 'public' : 'folder' }}</mat-icon>
                {{ selectedCollection.name }}
              </mat-card-title>
              <mat-card-subtitle *ngIf="selectedCollection.description">
                {{ selectedCollection.description }}
              </mat-card-subtitle>
            </div>
            
            <div class="collection-actions">
              <button 
                mat-icon-button 
                (click)="onEditCollection()"
                matTooltip="Edit collection">
                <mat-icon>edit</mat-icon>
              </button>
              <button 
                mat-icon-button 
                [matMenuTriggerFor]="collectionMenu"
                matTooltip="More actions">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #collectionMenu="matMenu">
                <button mat-menu-item (click)="onEditCollection()">
                  <mat-icon>edit</mat-icon>
                  Edit Collection
                </button>
                <mat-divider></mat-divider>
                <button mat-menu-item (click)="onDeleteCollection()" class="delete-action">
                  <mat-icon>delete</mat-icon>
                  Delete Collection
                </button>
              </mat-menu>
            </div>
          </mat-card-header>
          
          <mat-card-content>
            <div class="collection-stats">
              <div class="stat-item">
                <mat-icon>restaurant</mat-icon>
                <span>{{ selectedCollection.recipe_count }} Recipes</span>
              </div>
              <div class="stat-item">
                <mat-icon>{{ selectedCollection.is_public ? 'public' : 'lock' }}</mat-icon>
                <span>{{ selectedCollection.is_public ? 'Public' : 'Private' }}</span>
              </div>
              <div class="stat-item">
                <mat-icon>schedule</mat-icon>
                <span>Created {{ selectedCollection.created_at | date:'mediumDate' }}</span>
              </div>
            </div>

            <!-- View Mode Toggle -->
            <div class="view-controls" *ngIf="hasRecipes">
              <mat-button-toggle-group 
                [(value)]="viewMode" 
                (change)="onViewModeChange($event.value)">
                <mat-button-toggle value="grid" matTooltip="Grid view">
                  <mat-icon>grid_view</mat-icon>
                </mat-button-toggle>
                <mat-button-toggle value="list" matTooltip="List view">
                  <mat-icon>view_list</mat-icon>
                </mat-button-toggle>
              </mat-button-toggle-group>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Collection Recipes -->
        <div class="collection-recipes">
          
          <!-- No Recipes in Collection -->
          <div *ngIf="!hasRecipes" class="no-recipes">
            <mat-card class="no-recipes-card">
              <mat-icon class="no-recipes-icon">restaurant</mat-icon>
              <h3>No recipes in this collection</h3>
              <p>This collection is empty. Add some recipes to start organizing your favorites!</p>
              <div class="no-recipes-actions">
                <button mat-raised-button color="primary" routerLink="/recipes">
                  <mat-icon>search</mat-icon>
                  Browse Recipes
                </button>
                <button mat-stroked-button routerLink="/dashboard/favorites">
                  <mat-icon>favorite</mat-icon>
                  View Favorites
                </button>
              </div>
            </mat-card>
          </div>

          <!-- Recipes Grid View -->
          <div *ngIf="hasRecipes && viewMode === 'grid'" class="recipes-grid">
            <mat-card 
              *ngFor="let recipe of collectionRecipes; trackBy: trackByRecipeId"
              class="recipe-card"
              (click)="onViewRecipe(recipe)">
              
              <div class="recipe-image-container">
                <img 
                  [src]="getRecipeImageUrl(recipe)" 
                  [alt]="recipe.title"
                  class="recipe-image"
                  loading="lazy">
                <div class="recipe-actions">
                  <button 
                    mat-icon-button 
                    (click)="$event.stopPropagation(); onRemoveRecipeFromCollection(recipe)"
                    matTooltip="Remove from collection"
                    class="remove-action">
                    <mat-icon>remove_circle</mat-icon>
                  </button>
                </div>
              </div>

              <mat-card-content class="recipe-info">
                <h3 class="recipe-title">{{ recipe.title }}</h3>
                <p class="recipe-description">{{ recipe.description | slice:0:80 }}{{ recipe.description.length > 80 ? '...' : '' }}</p>
                
                <div class="recipe-meta">
                  <div class="meta-item">
                    <mat-icon class="meta-icon">schedule</mat-icon>
                    <span>{{ recipe.total_time }}m</span>
                  </div>
                  <div class="meta-item">
                    <mat-icon class="meta-icon">people</mat-icon>
                    <span>{{ recipe.servings }}</span>
                  </div>
                </div>

                <div class="recipe-rating">
                  <app-star-rating 
                    [value]="getRecipeRating(recipe)"
                    [interactive]="false"
                    [showValue]="true"
                    [count]="getRecipeRatingCount(recipe)"
                    [showCount]="true"
                    [size]="14">
                  </app-star-rating>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Recipes List View -->
          <div *ngIf="hasRecipes && viewMode === 'list'" class="recipes-list">
            <mat-card class="list-card">
              <div 
                *ngFor="let recipe of collectionRecipes; trackBy: trackByRecipeId"
                class="recipe-list-item"
                (click)="onViewRecipe(recipe)">
                
                <img 
                  [src]="getRecipeImageUrl(recipe)" 
                  [alt]="recipe.title"
                  class="list-item-image"
                  loading="lazy">
                
                <div class="list-item-info">
                  <h3 class="list-item-title">{{ recipe.title }}</h3>
                  <p class="list-item-description">{{ recipe.description | slice:0:120 }}{{ recipe.description.length > 120 ? '...' : '' }}</p>
                  
                  <div class="list-item-meta">
                    <span class="meta-tag">
                      <mat-icon>schedule</mat-icon>
                      {{ recipe.total_time }}m
                    </span>
                    <span class="meta-tag">
                      <mat-icon>people</mat-icon>
                      {{ recipe.servings }} servings
                    </span>
                    <span class="meta-tag difficulty-{{ recipe.difficulty }}">
                      {{ recipe.difficulty }}
                    </span>
                    <app-star-rating 
                      [value]="getRecipeRating(recipe)"
                      [interactive]="false"
                      [showValue]="true"
                      [size]="12">
                    </app-star-rating>
                  </div>
                </div>

                <div class="list-item-actions">
                  <button 
                    mat-icon-button 
                    (click)="$event.stopPropagation(); onRemoveRecipeFromCollection(recipe)"
                    matTooltip="Remove from collection"
                    class="remove-action">
                    <mat-icon>remove_circle</mat-icon>
                  </button>
                </div>
              </div>
            </mat-card>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Collection Form Dialog -->
  <div class="collection-form-overlay" *ngIf="isCreatingCollection || isEditingCollection" (click)="cancelCollectionEdit()">
    <mat-card class="collection-form-card" (click)="$event.stopPropagation()">
      <mat-card-header>
        <mat-card-title>
          {{ isCreatingCollection ? 'Create New Collection' : 'Edit Collection' }}
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="collectionForm" (ngSubmit)="onSaveCollection()">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Collection Name</mat-label>
            <input matInput formControlName="name" maxlength="50" required>
            <mat-error *ngIf="collectionForm.get('name')?.hasError('required')">
              Collection name is required
            </mat-error>
            <mat-error *ngIf="collectionForm.get('name')?.hasError('minlength')">
              Name must be at least 2 characters
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description (optional)</mat-label>
            <textarea matInput formControlName="description" rows="3" maxlength="200"></textarea>
            <mat-hint>{{ collectionForm.get('description')?.value?.length || 0 }}/200</mat-hint>
          </mat-form-field>

          <mat-checkbox formControlName="is_public" class="full-width">
            Make this collection public
            <small class="checkbox-hint">Public collections can be viewed by other users</small>
          </mat-checkbox>
        </form>
      </mat-card-content>
      
      <mat-card-actions align="end">
        <button mat-button (click)="cancelCollectionEdit()">Cancel</button>
        <button 
          mat-raised-button 
          color="primary" 
          (click)="onSaveCollection()"
          [disabled]="!collectionForm.valid">
          {{ isCreatingCollection ? 'Create' : 'Save' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div>