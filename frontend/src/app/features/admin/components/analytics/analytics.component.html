<div class="analytics">
  <div class="page-header">
    <h1>Analytics & Reporting</h1>
    <p>Platform insights, trends, and performance metrics</p>
  </div>

  <!-- Period Selector -->
  <mat-card class="period-selector">
    <mat-card-content>
      <form [formGroup]="periodForm" (ngSubmit)="updatePeriod()">
        <div class="period-controls">
          <mat-form-field appearance="fill">
            <mat-label>Time Period</mat-label>
            <mat-select formControlName="period">
              <mat-option value="7d">Last 7 Days</mat-option>
              <mat-option value="30d">Last 30 Days</mat-option>
              <mat-option value="90d">Last 90 Days</mat-option>
              <mat-option value="1y">Last Year</mat-option>
            </mat-select>
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit">
            <mat-icon>refresh</mat-icon>
            Update
          </button>
          <button mat-stroked-button type="button" (click)="refreshCharts()">
            <mat-icon>sync</mat-icon>
            Refresh Charts
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading analytics data...</p>
  </div>

  <!-- Analytics Content -->
  <div *ngIf="!loading" class="analytics-content">
    <!-- Key Metrics -->
    <div class="metrics-section">
      <h2>Key Metrics</h2>
      <div class="metrics-grid">
        <mat-card class="metric-card">
          <mat-card-content>
            <div class="metric-icon">
              <mat-icon>trending_up</mat-icon>
            </div>
            <div class="metric-content">
              <h3>{{ totalUsers }}</h3>
              <p>Total Users</p>
              <small>+{{ getGrowthRate(userGrowthData) }}% from last period</small>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="metric-card">
          <mat-card-content>
            <div class="metric-icon">
              <mat-icon>restaurant</mat-icon>
            </div>
            <div class="metric-content">
              <h3>{{ totalRecipes }}</h3>
              <p>Total Recipes</p>
              <small>+{{ getGrowthRate(recipeActivityData) }}% from last period</small>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="metric-card">
          <mat-card-content>
            <div class="metric-icon">
              <mat-icon>star</mat-icon>
            </div>
            <div class="metric-content">
              <h3>{{ totalRatings }}</h3>
              <p>Total Ratings</p>
              <small>Average: {{ getAverageRating(ratingDistributionData) }}/5</small>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="metric-card">
          <mat-card-content>
            <div class="metric-icon">
              <mat-icon>visibility</mat-icon>
            </div>
            <div class="metric-content">
              <h3>{{ getTotalViews(topRecipes) }}</h3>
              <p>Total Views</p>
              <small>Across all recipes</small>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Charts Section -->
    <mat-tab-group class="charts-section">
      <mat-tab label="User Growth">
        <div class="chart-container">
          <h3>User Growth Over Time</h3>
          <div class="chart-wrapper">
            <canvas baseChart
              [data]="userGrowthChartData"
              [options]="userGrowthChartOptions"
              [type]="userGrowthChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Recipe Activity">
        <div class="chart-container">
          <h3>Recipe Creation Activity</h3>
          <div class="chart-wrapper">
            <canvas baseChart
              [data]="recipeActivityChartData"
              [options]="recipeActivityChartOptions"
              [type]="recipeActivityChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Category Distribution">
        <div class="chart-container">
          <h3>Recipes by Category</h3>
          <div class="chart-wrapper">
            <canvas baseChart
              [data]="categoryDistributionChartData"
              [options]="categoryDistributionChartOptions"
              [type]="categoryDistributionChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Rating Distribution">
        <div class="chart-container">
          <h3>Rating Distribution</h3>
          <div class="chart-wrapper">
            <canvas baseChart
              [data]="ratingDistributionChartData"
              [options]="ratingDistributionChartOptions"
              [type]="ratingDistributionChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- Top Performers -->
    <div class="top-performers-section">
      <h2>Top Performers</h2>
      
      <div class="performers-grid">
        <!-- Top Recipes -->
        <mat-card class="performer-card">
          <mat-card-header>
            <mat-card-title>Top Recipes</mat-card-title>
            <mat-card-subtitle>Most viewed and favorited</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="performer-list">
              <div *ngFor="let recipe of topRecipes?.slice(0, 5); let i = index" class="performer-item">
                <div class="rank">{{ i + 1 }}</div>
                <div class="performer-info">
                  <div class="performer-name">{{ recipe.title }}</div>
                  <div class="performer-stats">
                    <span>{{ recipe.views }} views</span>
                    <span>{{ recipe.favorites }} favorites</span>
                    <span>{{ recipe.average_rating.toFixed(1) }} ⭐</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Top Categories -->
        <mat-card class="performer-card">
          <mat-card-header>
            <mat-card-title>Top Categories</mat-card-title>
            <mat-card-subtitle>Most popular categories</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="performer-list">
              <div *ngFor="let category of analyticsData?.top_categories?.slice(0, 5); let i = index" class="performer-item">
                <div class="rank">{{ i + 1 }}</div>
                <div class="performer-info">
                  <div class="performer-name">{{ category.name }}</div>
                  <div class="performer-stats">
                    <span>{{ category.recipe_count }} recipes</span>
                    <span>{{ category.average_rating.toFixed(1) }} ⭐</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Top Users -->
        <mat-card class="performer-card">
          <mat-card-header>
            <mat-card-title>Top Users</mat-card-title>
            <mat-card-subtitle>Most active contributors</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <div class="performer-list">
              <div *ngFor="let user of analyticsData?.top_users?.slice(0, 5); let i = index" class="performer-item">
                <div class="rank">{{ i + 1 }}</div>
                <div class="performer-info">
                  <div class="performer-name">{{ user.username }}</div>
                  <div class="performer-stats">
                    <span>{{ user.recipe_count }} recipes</span>
                    <span>{{ user.total_views }} views</span>
                    <span>{{ user.average_rating.toFixed(1) }} ⭐</span>
                  </div>
                </div>
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Export Section -->
    <div class="export-section">
      <h2>Export Reports</h2>
      <div class="export-actions">
        <button mat-raised-button color="primary" (click)="exportUserReport()">
          <mat-icon>download</mat-icon>
          Export User Report
        </button>
        <button mat-raised-button color="accent" (click)="exportRecipeReport()">
          <mat-icon>download</mat-icon>
          Export Recipe Report
        </button>
        <button mat-raised-button color="warn" (click)="exportEngagementReport()">
          <mat-icon>download</mat-icon>
          Export Engagement Report
        </button>
      </div>
    </div>
  </div>
</div> 