<div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Loading State -->
      <div *ngIf="loading()" class="flex justify-center items-center min-h-[400px]">
        <mat-spinner diameter="40"></mat-spinner>
      </div>

      <!-- Form Content -->
      <div *ngIf="!loading()">
        <!-- Header -->
        <div class="mb-6">
          <div class="flex items-center gap-2 mb-4">
            <button mat-icon-button (click)="goBack()" class="text-gray-600">
              <mat-icon>arrow_back</mat-icon>
            </button>
            <h1 class="text-3xl font-bold text-gray-900">
              {{ isEditing() ? 'Edit Recipe' : 'Create New Recipe' }}
            </h1>
          </div>
          <p class="text-gray-600">
            {{ isEditing() ? 'Update your recipe details below' : 'Share your culinary creation with the community' }}
          </p>
        </div>

        <!-- Recipe Form -->
        <form [formGroup]="recipeForm" (ngSubmit)="onSubmit()" class="space-y-6">
          <!-- Basic Information -->
          <mat-card>
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>info</mat-icon>
                Basic Information
              </mat-card-title>
            </mat-card-header>
            <mat-card-content class="space-y-4">
              <!-- Title -->
              <mat-form-field appearance="fill" class="w-full">
                <mat-label>Recipe Title</mat-label>
                <input matInput formControlName="title" placeholder="Enter a catchy recipe title">
                <mat-error *ngIf="recipeForm.get('title')?.hasError('required')">
                  Title is required
                </mat-error>
                <mat-error *ngIf="recipeForm.get('title')?.hasError('minlength')">
                  Title must be at least 3 characters
                </mat-error>
              </mat-form-field>

              <!-- Description -->
              <mat-form-field appearance="fill" class="w-full">
                <mat-label>Description</mat-label>
                <textarea matInput formControlName="description" rows="3" 
                         placeholder="Describe your recipe..."></textarea>
                <mat-error *ngIf="recipeForm.get('description')?.hasError('required')">
                  Description is required
                </mat-error>
              </mat-form-field>

              <!-- Image Upload -->
              <div class="space-y-3">
                <label class="block text-sm font-medium text-gray-700">Recipe Image</label>
                <div class="flex items-center gap-4">
                  <input type="file" #fileInput (change)="onImageSelected($event)" 
                         accept="image/*" class="hidden">
                  <button type="button" mat-stroked-button (click)="fileInput.click()">
                    <mat-icon>cloud_upload</mat-icon>
                    {{ selectedImage() ? 'Change Image' : 'Upload Image' }}
                  </button>
                  <span *ngIf="selectedImage()" class="text-sm text-gray-600">
                    {{ selectedImage()?.name }}
                  </span>
                </div>
                <!-- Image Preview -->
                <div *ngIf="imagePreview()" class="mt-3">
                  <img [src]="imagePreview()" alt="Preview" 
                       class="w-32 h-32 object-cover rounded border">
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Time and Serving Information -->
          <mat-card>
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>schedule</mat-icon>
                Timing & Servings
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                <mat-form-field appearance="fill">
                  <mat-label>Prep Time (minutes)</mat-label>
                  <input matInput type="number" formControlName="prep_time" min="1">
                  <mat-error *ngIf="recipeForm.get('prep_time')?.hasError('required')">
                    Prep time is required
                  </mat-error>
                  <mat-error *ngIf="recipeForm.get('prep_time')?.hasError('min')">
                    Prep time must be at least 1 minute
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Cook Time (minutes)</mat-label>
                  <input matInput type="number" formControlName="cook_time" min="1">
                  <mat-error *ngIf="recipeForm.get('cook_time')?.hasError('required')">
                    Cook time is required
                  </mat-error>
                  <mat-error *ngIf="recipeForm.get('cook_time')?.hasError('min')">
                    Cook time must be at least 1 minute
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Servings</mat-label>
                  <input matInput type="number" formControlName="servings" min="1">
                  <mat-error *ngIf="recipeForm.get('servings')?.hasError('required')">
                    Servings is required
                  </mat-error>
                  <mat-error *ngIf="recipeForm.get('servings')?.hasError('min')">
                    Must serve at least 1 person
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Difficulty</mat-label>
                  <mat-select formControlName="difficulty">
                    <mat-option *ngFor="let difficulty of difficultyOptions" [value]="difficulty.value">
                      {{ difficulty.label }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="recipeForm.get('difficulty')?.hasError('required')">
                    Difficulty is required
                  </mat-error>
                </mat-form-field>
              </div>

              <!-- Total Time Display -->
              <div *ngIf="totalTime() > 0" class="mt-3 p-3 bg-blue-50 rounded">
                <span class="text-sm font-medium text-blue-800">
                  Total Time: {{ totalTime() }} minutes
                </span>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Recipe Details -->
          <mat-card>
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>restaurant</mat-icon>
                Recipe Details
              </mat-card-title>
            </mat-card-header>
            <mat-card-content class="space-y-4">
              <div class="grid md:grid-cols-2 gap-4">
                <mat-form-field appearance="fill">
                  <mat-label>Cooking Method</mat-label>
                  <mat-select formControlName="cooking_method">
                    <mat-option *ngFor="let method of cookingMethodOptions" [value]="method.value">
                      {{ method.label }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Cuisine Type</mat-label>
                  <input matInput formControlName="cuisine_type" placeholder="e.g., Italian, Mexican">
                </mat-form-field>
              </div>

              <!-- Categories -->
              <mat-form-field appearance="fill" class="w-full">
                <mat-label>Categories</mat-label>
                <mat-select formControlName="categories" multiple>
                  <mat-option *ngFor="let category of categories()" [value]="category.id">
                    {{ category.name }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Note about dietary restrictions -->
              <div class="p-3 bg-blue-50 rounded border border-blue-200">
                <div class="flex items-start gap-2">
                  <mat-icon class="text-blue-600 mt-0.5" style="font-size: 18px;">info</mat-icon>
                  <div class="text-sm text-blue-800">
                    <strong>Dietary Information:</strong> Use tags (e.g., "vegetarian", "vegan", "gluten-free") 
                    or include dietary information in the description for searchability.
                  </div>
                </div>
              </div>

              <!-- Tags -->
              <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">Tags</label>
                <div class="flex gap-2 flex-wrap mb-2">
                  <mat-chip *ngFor="let tag of tags(); let i = index" 
                           (removed)="removeTag(i)" removable>
                    {{ tag }}
                    <mat-icon matChipRemove>cancel</mat-icon>
                  </mat-chip>
                </div>
                <div class="flex gap-2">
                  <mat-form-field appearance="fill" class="flex-1">
                    <mat-label>Add Tag</mat-label>
                    <input matInput #tagInput (keyup.enter)="addTag(tagInput.value); tagInput.value = ''" 
                           placeholder="Enter a tag and press Add button">
                  </mat-form-field>
                  <button type="button" mat-button (click)="addTag(tagInput.value); tagInput.value = ''"
                          [disabled]="!tagInput.value.trim()">
                    Add
                  </button>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Ingredients -->
          <mat-card>
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <!-- <mat-icon>shopping_list</mat-icon> -->
                Ingredients
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div formArrayName="ingredients" class="space-y-3">
                <div *ngFor="let ingredient of ingredientsArray.controls; let i = index" 
                     class="flex gap-2 items-start">
                  <div [formGroupName]="i" class="flex gap-2 flex-1">
                    <mat-form-field appearance="fill" style="width: 120px; min-width: 120px; max-width: 150px;">
                      <mat-label>Amount</mat-label>
                      <input matInput formControlName="amount" placeholder="e.g., 2 cups">
                      <mat-error *ngIf="ingredient.get('amount')?.hasError('required')">
                        Amount is required
                      </mat-error>
                    </mat-form-field>
                    <mat-form-field appearance="fill" style="flex: 1; min-width: 0;">
                      <mat-label>Ingredient</mat-label>
                      <input matInput formControlName="name" placeholder="e.g., flour">
                      <mat-error *ngIf="ingredient.get('name')?.hasError('required')">
                        Ingredient name is required
                      </mat-error>
                    </mat-form-field>
                  </div>
                  <button type="button" mat-icon-button color="warn" 
                          (click)="removeIngredient(i)" [disabled]="ingredientsArray.length <= 1">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              <button type="button" mat-button (click)="addIngredient()" class="mt-3">
                <mat-icon>add</mat-icon>
                Add Ingredient
              </button>
            </mat-card-content>
          </mat-card>

          <!-- Instructions -->
          <mat-card>
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>list_alt</mat-icon>
                Instructions
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div formArrayName="instructions" class="space-y-3">
                <div *ngFor="let instruction of instructionsArray.controls; let i = index" 
                     class="flex gap-2 items-start">
                  <div class="flex-shrink-0 w-8 h-8 bg-primary text-white rounded-full flex items-center justify-center text-sm font-semibold mt-2">
                    {{ i + 1 }}
                  </div>
                  <mat-form-field appearance="fill" class="flex-1">
                    <mat-label>Step {{ i + 1 }}</mat-label>
                    <textarea matInput [formControlName]="i" rows="2" 
                             placeholder="Describe this step in detail"></textarea>
                    <mat-error *ngIf="instruction.hasError('required')">
                      Instruction is required
                    </mat-error>
                  </mat-form-field>
                  <button type="button" mat-icon-button color="warn" 
                          (click)="removeInstruction(i)" [disabled]="instructionsArray.length <= 1">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
              </div>
              <button type="button" mat-button (click)="addInstruction()" class="mt-3">
                <mat-icon>add</mat-icon>
                Add Step
              </button>
            </mat-card-content>
          </mat-card>

          <!-- Nutrition Information (Optional) -->
          <mat-card>
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>nutrition</mat-icon>
                Nutrition Information (Optional)
              </mat-card-title>
              <mat-card-subtitle>Per serving</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div formGroupName="nutrition_info" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                <mat-form-field appearance="fill">
                  <mat-label>Calories</mat-label>
                  <input matInput type="number" formControlName="calories" min="0">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Protein (g)</mat-label>
                  <input matInput type="number" formControlName="protein" min="0" step="0.1">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Carbs (g)</mat-label>
                  <input matInput type="number" formControlName="carbs" min="0" step="0.1">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Fat (g)</mat-label>
                  <input matInput type="number" formControlName="fat" min="0" step="0.1">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Fiber (g)</mat-label>
                  <input matInput type="number" formControlName="fiber" min="0" step="0.1">
                </mat-form-field>

                <mat-form-field appearance="fill">
                  <mat-label>Sugar (g)</mat-label>
                  <input matInput type="number" formControlName="sugar" min="0" step="0.1">
                </mat-form-field>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Publication Settings -->
          <!-- Publication Settings - Only visible to staff users -->
          <mat-card *ngIf="isStaff()">
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>visibility</mat-icon>
                Publication Settings
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-checkbox formControlName="is_published" class="mb-2">
                Publish this recipe
              </mat-checkbox>
              <p class="text-sm text-gray-600">
                Published recipes are visible to all users. Unpublished recipes are only visible to you.
              </p>
            </mat-card-content>
          </mat-card>

          <!-- Publication Options for regular users -->
          <mat-card *ngIf="!isStaff()">
            <mat-card-header>
              <mat-card-title class="flex items-center gap-2">
                <mat-icon>visibility</mat-icon>
                Publication Options
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-radio-group formControlName="is_published" class="space-y-3">
                <div class="flex items-start gap-3">
                  <mat-radio-button [value]="true" class="flex-1">
                    <div class="ml-2">
                      <div class="font-medium">Publish Now</div>
                      <div class="text-sm text-gray-600">Make this recipe immediately visible to all users</div>
                    </div>
                  </mat-radio-button>
                </div>
                <div class="flex items-start gap-3">
                  <mat-radio-button [value]="false" class="flex-1">
                    <div class="ml-2">
                      <div class="font-medium">Save as Draft</div>
                      <div class="text-sm text-gray-600">Keep this recipe private for now, you can publish it later</div>
                    </div>
                  </mat-radio-button>
                </div>
              </mat-radio-group>
            </mat-card-content>
          </mat-card>



          <!-- Form Actions -->
          <div class="flex gap-4 justify-end pt-6 border-t">
            <button type="button" mat-button (click)="goBack()">
              Cancel
            </button>
            <!-- <button type="button" mat-button color="primary" 
                    (click)="saveDraft()" [disabled]="submitting()">
              Save as Draft
            </button> -->
            
            <!-- Form Validation Status -->
            <div *ngIf="hasFormErrors()" class="flex flex-col text-red-600 text-sm mr-4 max-w-xs">
              <div class="flex items-center mb-2">
                <mat-icon class="text-red-600 mr-1">error</mat-icon>
                <span class="font-medium">Form has errors:</span>
              </div>
              <ul class="text-xs space-y-1">
                <li *ngFor="let error of getFormErrorMessages()" class="flex items-start">
                  <span class="text-red-500 mr-1">•</span>
                  <span>{{ error }}</span>
                </li>
              </ul>
            </div>
            
            <button type="submit" mat-raised-button color="primary" 
                    [disabled]="recipeForm.invalid || submitting()">
              <mat-icon *ngIf="submitting()">hourglass_empty</mat-icon>
              <mat-icon *ngIf="!submitting()">{{ isEditing() ? 'update' : (recipeForm.get('is_published')?.value ? 'publish' : 'save') }}</mat-icon>
              {{ submitting() ? 'Saving...' : (isEditing() ? 'Update Recipe' : (recipeForm.get('is_published')?.value ? 'Publish Recipe' : 'Save as Draft')) }}
            </button>
          </div>
        </form>
      </div>
    </div>